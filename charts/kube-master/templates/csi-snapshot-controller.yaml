{{- if .Values.openstack }}
{{- if (semverCompare ">= 1.20" .Values.version.kubernetes) }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "master.fullname" . }}-csisc
  namespace: {{ .Release.Namespace }}
  labels:
    app: {{ include "master.fullname" . }}-csisc
    role: controller
    chart: "{{ .Chart.Name }}-{{ .Chart.Version | replace "+" "_" }}"
    release: {{ .Release.Name }}
spec:
  replicas: {{ .Values.csiSnapshotController.replicas }}
  revisionHistoryLimit: 1
  selector:
    matchLabels:
      app: {{ include "master.fullname" . }}-csisc
      role: controller
  template:
    metadata:
      annotations:
{{- if .Values.csiSnapshotController.podAnnotations }}
{{ toYaml .Values.csiSnapshotController.podAnnotations | indent 8 }}
{{- end }}
      labels:
        app: {{ include "master.fullname" . }}-csisc
        role: controller
        release: {{ .Release.Name }}
    spec:
      initContainers:
      - name: apiserver-wait
        image: {{ include "kubelet.image" . | quote }}
        command:
        - sh
        - -c
        args:
        - until kubectl version --short --kubeconfig /etc/kubernetes/config/csi-kubeconfig --request-timeout=4s | grep -i "Server.*{{ .Values.version.kubernetes }}"; do sleep 5; done;
        volumeMounts:
        - mountPath: /etc/kubernetes/certs/
          name: certs
          readOnly: true
        - mountPath: /etc/kubernetes/config
          name: config
          readOnly: true
      containers:
      - name: csi-snapshot-controller
        image: {{ include "csiSnapshotController.image" . }}
        imagePullPolicy: IfNotPresent
        args:
        - --kubeconfig=/etc/kubernetes/config/csi-kubeconfig
        - --leader-election={{ .Values.csiSnapshotController.leaderElection }}
        {{- if .Values.csiSnapshotController.leaderElectionNamespace }}
        - --leader-election-namespace={{ .Values.csiSnapshotController.leaderElectionNamespace }}
        {{- end }}
{{- if .Values.csiSnapshotController.resources }}
        resources:
{{ toYaml .Values.csiSnapshotController.resources | indent 10 }}
{{- end }}
        volumeMounts:
        - mountPath: /etc/kubernetes/config
          name: config
          readOnly: true
        - mountPath: /etc/kubernetes/certs/
          name: certs
          readOnly: true
      volumes:
      - name: config
        configMap:
          name: {{ include "master.fullname" . }}
      - name: certs
        secret:
          secretName: {{ .Values.secretName }}
          items:
          - key: tls-ca.pem
            path: tls-ca.pem
          - key: apiserver-clients-csi-controller.pem
            path: csi-client.pem
          - key: apiserver-clients-csi-controller-key.pem
            path: csi-client.key
{{- end }}
{{- end }}
